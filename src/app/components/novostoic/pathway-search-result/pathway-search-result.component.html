<div class="flex h-full max-w-screen-xl flex-col justify-between">
    <div class="flex grow flex-col" *ngIf="(statusResponse$ | async) as status">
        <!-- TODO: use real data -->
        <div class="flex justify-between">
            <div>
                <h2 class="mb-2">
                    Job ID: {{ status.job_id || 'loading' }} <button type="button" title="copy job id"><i class="pi pi-copy"></i></button>
                </h2>
                <p class="leading-6">
                    Submission Time: {{ status.time_created | date: 'short' }}
                </p>
            </div>
            <div class="flex items-center">
                <div class="flex items-center gap-2">
                    <button 
                        *ngIf="isLoading$ | async"
                        class="rounded-md border p-2 py-3"
                    >
                        Cancel
                    </button>

                    <a href="/pathway-search" target="_blank">
                        <button class="rounded-md border p-2 py-3">
                            <i class="pi pi-plus mx-2"></i>
                            Run a new Request
                        </button>
                    </a>
                </div>
            </div>
        </div>

        <hr />

        <!-- Molecule Input -->
        <ng-container *ngIf="!(isLoading$ | async)">
            <div *ngIf="(response$ | async) as response" class="mt-8 flex grow flex-col gap-6">
                <div class="flex justify-between gap-4">
                    <div class="relative flex flex-col max-w-screen-md">
                        <span class="text-sm font-light"
                            >Selected Stoichiometry</span
                        >
                        <app-stoichiometry-reaction-with-scroller
                            [primaryPrecursor]="response.primaryPrecursor"
                            [targetMolecule]="response.targetMolecule"
                            [stoichiometry]="response.stoichiometry"
                            [moleculeStyleClass]="'bg-[#f5f5f5]'"
                            maxWidth="600px"
                        ></app-stoichiometry-reaction-with-scroller>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-sm font-light"
                            >Auxiliary functions</span
                        >
                        <div class="mt-2 flex items-center">
                            <span class="mr-4">Delta G (kJ/mol)</span>
                            <p-checkbox class="mr-2"></p-checkbox> Enzyme
                            selection
                        </div>
                    </div>
                </div>

                <div class="mt-2 flex grow">
                    <div
                        class="border-green-primary relative flex w-[150px] flex-col gap-4 border border-solid"
                    >
                        <div
                            class="border-green-primary border-b border-solid"
                        >
                            <img
                                [src]="response.primaryPrecursor.structure"
                                class="h-[120px]"
                            />
                        </div>
                        <ng-container
                            *ngTemplateOutlet="moleculeInfo; context: { $implicit: response.primaryPrecursor } "
                        ></ng-container>
                    </div>
                    <div
                        class="relative grow border border-solid border-[--surface-d]"
                    >
                        <div class="absolute h-full w-full overflow-scroll">
                            <div
                                class="relative left-0 top-0 min-h-full min-w-full"
                                [style]="(tableStyle$ | async) || {}"
                            >
                                <ng-container *ngIf="(maxPathwayStepsTemplateArray$ | async) as stepsArray">
                                    <ng-container *ngIf="(emptyPathwayHeadersArray$ | async) as emptyHeaderArray">
                                        <ng-container *ngIf="(emptyPathwayStepsArrays$ | async) as emptyStepsArray">
                                            <table
                                                class="absolute left-0 top-0 min-w-full table-fixed"
                                            >
                                                <tr>
                                                    <th
                                                        class="bg-[--surface-b] sticky left-0 top-0 z-20 w-[20px] font-semibold text-[--text-color-secondary]"
                                                    >
                                                        P\S
                                                    </th>
                                                    <ng-container
                                                        *ngFor="let step of stepsArray; let i = index"
                                                    >
                                                        <th
                                                            class="sticky top-0 z-10 w-[60px] bg-[--surface-b] p-1 text-[--text-color-secondary]"
                                                        >
                                                            STEP {{ step }}
                                                        </th>
                                                        <th
                                                            *ngIf="i !== stepsArray.length - 1"
                                                            class="sticky top-0 z-10 bg-gray-50"
                                                            [class.w-[130px]]="
                                                                    emptyHeaderArray.length
                                                                    || i !== stepsArray!.length - 1"
                                                        ></th>
                                                    </ng-container>
                                                    <ng-container
                                                        *ngFor="let header of emptyHeaderArray; let i = index"
                                                    >
                                                        <th
                                                            class="sticky top-0 z-10 w-[60px] bg-gray-50 p-1"
                                                        ></th>
                                                        <th
                                                            *ngIf="i !== stepsArray.length - 1"
                                                            class="sticky top-0 z-10 bg-gray-50"
                                                            [class.w-[130px]]="i !== emptyHeaderArray.length - 1"
                                                        ></th>
                                                    </ng-container>
                                                </tr>
                                                <!-- Data in Table -->
                                                <ng-container
                                                    *ngFor="let pathway of response.pathways; let i = index"
                                                >
                                                    <tr class="h-[120px]">
                                                        <td
                                                            class="sticky left-0 z-10 bg-[--surface-b]"
                                                        >
                                                            <span
                                                                class="absolute -left-8 top-[3.4rem] -rotate-90 text-nowrap bg-[--surface-b] p-1 text-[--surface-600]"
                                                                >PATHWAY {{ i +
                                                                1}}</span
                                                            >
                                                        </td>
                                                        <ng-container
                                                            *ngFor="let reaction of pathway; let j = index"
                                                        >
                                                            <ng-container
                                                                *ngTemplateOutlet="tableCellReaction; context: {
                                                                    $implicit: reaction,
                                                                    label: 'R' + (i + 1) + '.' + (j + 1),
                                                                    pathwayIndex: i,
                                                                    inFirstColumn: j === 0,
                                                                    inLastColumn: j === pathway.length - 1
                                                                } "
                                                            ></ng-container>
                                                            <ng-container
                                                                *ngIf="j !== pathway.length - 1"
                                                            >
                                                                <ng-container
                                                                    *ngTemplateOutlet="tableCellImg; context: { 
                                                                        $implicit: 'https://fakeimg.pl/640x360',
                                                                        predicted: reaction.isPrediction,
                                                                        nextPredicted: j === pathway.length - 1 ? false : pathway[j + 1].isPrediction
                                                                    }"
                                                                ></ng-container>
                                                            </ng-container>
                                                        </ng-container>
                                                        <ng-container
                                                            *ngFor="let slot of emptyStepsArray[i]; let j = index"
                                                        >
                                                            <td
                                                                class="relative align-middle"
                                                            >
                                                                <div
                                                                    class="h-[.1rem] w-full relative z-10"
                                                                    [class.bg-[--surface-500]]="!pathway[pathway.length - 1].isPrediction"
                                                                    [class.strip_pattern_to_right]="pathway[pathway.length - 1].isPrediction"
                                                                ></div>
                                                                <ng-container *ngTemplateOutlet="tableCellBackground"></ng-container>
                                                            </td>
                                                        </ng-container>
                                                    </tr>
                                                </ng-container>
                                            </table>
                                        </ng-container>
                                    </ng-container>
                                </ng-container>
                            </div>
                        </div>
                    </div>
                    <div
                        class="border-blue-primary relative flex w-[150px] flex-col gap-4 border border-solid"
                    >
                        <div
                            class="border-blue-primary border-b border-solid"
                        >
                            <img
                                [src]="response.targetMolecule.structure"
                                class="h-[120px]"
                            />
                        </div>
                        <ng-container
                            *ngTemplateOutlet="moleculeInfo; context: { $implicit: response.targetMolecule } "
                        ></ng-container>
                    </div>
                </div>
            </div>
        </ng-container>

        <app-loading *ngIf="isLoading$ | async"></app-loading>
    </div>
</div>

<ng-template #moleculeInfo let-molecule>
    <div class="px-4">
        <div class="font-light">Name</div>
        <div class="font-semibold">{{ molecule.commonNames[0] }}</div>
    </div>
    <div class="px-4">
        <div class="font-light">SMILES</div>
        <div class="font-semibold">{{ molecule.smiles }}</div>
    </div>
    <div class="px-4">
        <div class="font-light">KEGG ID</div>
        <div class="font-semibold">{{ molecule.keggId }}</div>
    </div>
</ng-template>

<ng-template
    #tableCellReaction
    let-reaction
    let-pathwayIndex="pathwayIndex"
    let-label="label"
    let-inLastColumn="inLastColumn"
    let-inFirstColumn="inFirstColumn"
>
    <td class="relative w-[120px] text-center align-middle">
        <ng-container *ngTemplateOutlet="tableCellBackground"></ng-container>
        <div
            class="absolute left-0 right-0 top-0 flex h-full items-center"
            [class.with-start-point]="inFirstColumn"
            [class.left-2]="inFirstColumn"
            [class.left-0]="!inFirstColumn"
        >
            <span
                class="z-0 h-[.1rem] w-full"
                [class.strip_pattern_to_right]="reaction.isPrediction"
                [class.bg-[--surface-500]]="!reaction.isPrediction"
            ></span>
        </div>
        <button
            class="z-1 relative cursor-pointer rounded-full border bg-white p-1 px-2"
            [class.border-solid]="!reaction.isPrediction"
            [class.border-[--surface-500]]="!reaction.isPrediction"
            [class.bg-[#FEFBF3]]="reaction.isPrediction"
            [class.border-dashed]="reaction.isPrediction"
            [class.border-[#C79807]]="reaction.isPrediction"
            (click)="reactionDetail.toggle($event)"
        >
            <span class="absolute -top-4 left-0 text-xs text-[--surface-500] flex items-center" [class.text-[#C79807]]="reaction.isPrediction">{{ label }} <i *ngIf="reaction.isPrediction" class="pi pi-exclamation-triangle text-xs mx-1"></i></span>
            <span class="font-semibold text-black">-{{ reaction.deltaG }}</span>
            <span class="font-light text-xs ml-1 text-[#212121]/50">kJ/mol</span>
        </button>
        <p-overlayPanel #reactionDetail>
            <div class="flex flex-col rounded-lg bg-[#224063] p-4 text-white">
                <div>
                    <span class="font-semibold"
                        >{{ reaction.primaryPrecursor.commonNames[0] }}</span
                    >
                    <span
                        *ngFor="let reactant of reaction.reactants"
                        class="text-white/50"
                    >
                        + {{ reactant.commonNames[0] }}
                    </span>
                    <i class="pi pi-arrow-right mx-2 text-sm"></i>
                    <span
                        *ngFor="let reactant of reaction.products"
                        class="text-white/50"
                    >
                        {{ reactant.commonNames[0] }} +
                    </span>
                    <span class="font-semibold"
                        >{{ reaction.targetMolecule.commonNames[0] }}</span
                    >
                    <button
                        class="ml-2 inline-flex items-center rounded-md bg-white/20 p-1"
                        (click)="visible$.next(true);selectedPathway$.next(pathwayIndex)"
                    >
                        <i class="pi pi-eye"></i>
                    </button>
                </div>
                <hr class="my-2" />
                <div class="flex justify-between gap-6">
                    <div class="flex w-1/2 justify-between">
                        <span class="font-light">∆G</span>
                        <span class="font-semibold"
                            >{{ reaction.deltaG }}kJ/mol</span
                        >
                    </div>
                    <div class="flex w-1/2 justify-between">
                        <span class="text-white/50">Reaction ID</span>
                        <span class="text-white/50"
                            >{{ reaction.reactionId }}</span
                        >
                    </div>
                </div>
                <div class="flex justify-between gap-6">
                    <div class="flex w-1/2 justify-between">
                        <span class="font-light">Enz</span>
                        <span class="font-semibold"
                            >{{ reaction.enzymes.length > 1 ? 'Multiple' :
                            reaction.enzymes[0].name }}</span
                        >
                    </div>
                    <div class="flex w-1/2 justify-between">
                        <span class="text-white/50">Confidence Score</span>
                        <span class="text-white/50"
                            >{{ reaction.confidenceScore }}</span
                        >
                    </div>
                </div>
            </div>
        </p-overlayPanel>
    </td>
</ng-template>

<ng-template #tableCellImg let-src let-nextPredicted="nextPredicted" let-predicted="predicted">
    <td class="w-[180px] align-middle relative">
        <ng-container *ngTemplateOutlet="tableCellBackground"></ng-container>
        <div
            class="table_cell_img relative flex items-center justify-center rounded-md border border-solid border-[--surface-500] bg-white py-1"
            [class.next_predicted]="nextPredicted"
            [class.predicted]="predicted"
        >
            <img [src]="src" class="w-[160px]" />
        </div>
    </td>
</ng-template>

<ng-template #tableCellBackground>
    <div class="absolute top-0 left-0 h-full w-full flex items-center z-0">
        <div class="h-[70%] w-full bg-[#F8F9FA]"></div>
    </div>
</ng-template>

<p-dialog
    [visible]="visible$.value"
    (visibleChange)="visible$.next($event)"
    [style]="{ width: '80rem' }"
    [modal]="true"
    [resizable]="false"
    [draggable]="false"
    class="pathway_dialog"
>
    <ng-template pTemplate="header">
        <div
            class="flex flex-col bg-gray-50 mx-4"
        >
            <ng-container *ngIf="(response$ | async) as response">
                <ng-container *ngIf="response.pathways[selectedPathway$.value] as pathway">
                    <div>Pathway {{ selectedPathway$.value + 1 }}:</div>
                    <div>
                        <span class="font-semibold">{{ pathway[0].primaryPrecursor!.commonNames[0] }}</span>
                        <span *ngFor="let reaction of pathway">
                            <i class="pi pi-arrow-right mx-2"></i>
                            <span class="font-semibold">{{ reaction.targetMolecule!.commonNames[0] }}</span>
                        </span>
                        <button type="button" title="download"><i class="pi pi-download mx-2"></i></button>
                    </div>
                </ng-container>
            </ng-container>
        </div>
    </ng-template>
    <ng-container *ngIf="(response$ | async) as response">
        <ng-container *ngIf="response.pathways[selectedPathway$.value] as pathway">
            <div class="flex justify-between m-4">
                <div class="flex gap-4">
                    <div class="rounded-md border border-[--surface-d] border-solid pb-4 pt-3 pl-5 pr-6">
                        <div class="text-lg font-semibold mb-2">{{ pathway.length }}</div>
                        <div>Total Steps</div>
                    </div>
                    <div class="rounded-md border border-[--surface-d] border-solid pb-4 pt-3 pl-5 pr-6">
                        <div class="text-lg font-semibold mb-2" *ngIf="(pathwayPredictedReactions$ | async) as reactions">{{ 
                            reactions![selectedPathway$.value].length
                        }}</div>
                        <div>Predicted Steps</div>
                    </div>
                    <div class="rounded-md border border-[--surface-d] border-solid pb-4 pt-3 pl-5 pr-6">
                        <div class="text-lg font-semibold mb-2">{{ pathway.length - 1 }}</div>
                        <div>Intermediates</div>
                    </div>
                    <div class="rounded-md border border-[--surface-d] border-solid pb-4 pt-3 pl-5 pr-6">
                        <div class="text-lg font-semibold mb-2" *ngIf="(pathwayDeltaGs$ | async) as deltaGs">{{ 
                            deltaGs![selectedPathway$.value] 
                        }}kJ/mol</div>
                        <div>Delta G</div>
                    </div>
                </div>
                <div class="flex flex-col">
                    <div class="font-semibold m-1">Legend:</div>
                    <table>
                        <tr>
                            <td class="py-1 align-middle"><div class="w-4 h-4 bg-green-primary text-[#495057] mx-1"></div></td>
                            <td class="py-1 align-middle"><div class="text-[#495057] mx-1">Primary Precursor</div></td>
                            <td class="py-1 align-middle"><div class="w-4 h-4 bg-blue-primary text-[#495057] mx-1"></div></td>
                            <td class="py-1 align-middle"><div class="text-[#495057] mx-1">Target Molecule</div></td>
                        </tr>
                        <tr>
                            <td class="py-1 align-middle"><div class="w-4 h-4 bg-[#FF4D00] text-[#495057] mx-1"></div></td>
                            <td class="py-1 align-middle"><div class="text-[#495057] mx-1">Intermediates</div></td>
                            <td class="py-1 align-middle"><div class="w-4 h-4 bg-[--surface-d] text-[#495057] mx-1"></div></td>
                            <td class="py-1 align-middle"><div class="text-[#495057] mx-1">Co-factors</div></td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="pt-12">
                <div class="flex flex-col justify-center mx-4" *ngFor="let reaction of pathway; let i = index">
                    <div class="w-full rounded-md border-black border border-solid flex"
                        [class.border-dashed]="reaction.isPrediction"
                    >
                        <div class="w-1/5 bg-gray-50 flex flex-col gap-4 p-4 rounded-md">
                            <div class="flex justify-between">
                                <span class="font-semibold">Reaction {{selectedPathway$.value + 1}}.{{ i + 1 }}</span>
                                <button type="button" title="download"><i class="pi pi-copy"></i></button>
                            </div>
                            <div>
                                <div class="mb-1">Delta G Calculation</div>
                                <div class="font-semibold">{{reaction.deltaG}}kJ/mol</div>
                            </div>
                            <div>
                                <div class="mb-1">Enzyme</div>
                                <table class="w-full">
                                    <tr class="align-middle" *ngFor="let enzyme of reaction.enzymes">
                                        <td class="font-semibold underline text-start">{{enzyme.name}}</td>
                                        <td class="text-end" *ngIf="reaction.isPrediction">{{enzyme.amount}}</td>
                                    </tr>
                                </table>
                            </div>
                            <div>
                                <div class="mb-1">Reaction ID (Kegg):</div>
                                <div class="font-semibold underline">{{reaction.reactionId}}</div>
                            </div>
                        </div>
                        <div class="flex items-center justify-around gap-2 w-full py-8 px-4">
                            <div class="flex items-center border border-solid rounded-md h-full p-2"
                                [class.border-[#ff4d00]]="i !== 0"
                                [class.border-green-primary]="i === 0"
                            >
                                <img [src]="reaction.primaryPrecursor!.structure" class="h-[120px]" />
                            </div>

                            <ng-container *ngFor="let reactant of reaction.reactants; let i = index">
                                <div class="flex items-center border border-solid border-[--surface-d] p-2 rounded-md h-full">
                                    <span>{{ reactant.commonNames[0] }}</span>
                                </div>
                                <i class="pi pi-plus" *ngIf="i !== reaction.reactants.length - 1"></i>
                            </ng-container>

                            <i class="pi pi-arrow-right"></i>

                            <ng-container *ngFor="let product of reaction.products; let i = index">
                                <i *ngIf="i !== 0" class="pi pi-plus"></i>
                                <div class="flex items-center border border-solid border-[--surface-d] p-2 rounded-md h-full">
                                    <span>{{ product.commonNames[0] }}</span>
                                </div>
                            </ng-container>
                            
                            <div class="flex items-center border border-solid rounded-md h-full p-2"
                                [class.border-[#ff4d00]]="i !== pathway.length - 1"
                                [class.border-blue-primary]="i === pathway.length - 1"
                            >
                                <img [src]="reaction.targetMolecule!.structure" class="h-[120px]" />
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-center" *ngIf="i !== pathway.length - 1">
                        <i class="pi pi-arrow-down text-xl"></i>
                    </div>
                </div>
            </div>
        </ng-container>
    </ng-container>
</p-dialog>
